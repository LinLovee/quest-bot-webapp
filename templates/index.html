<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneQuestRPG v5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a14 0%, #1a1a3f 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background: rgba(15, 15, 35, 0.95);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1 { font-size: 2.8em; text-align: center; color: #f39c12; margin-bottom: 20px; }
        h2 { font-size: 1.6em; color: #f39c12; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-bottom: 15px; }
        h3 { color: #3498db; margin-top: 15px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn-class { background: rgba(50, 50, 100, 0.7); border: 2px solid #555; border-radius: 12px; padding: 18px; cursor: pointer; text-align: center; transition: all 0.3s; color: #fff; }
        .btn-class:hover { border-color: #e74c3c; transform: translateY(-5px); box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4); }
        .stat { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 10px; background: rgba(50, 50, 80, 0.6); border-radius: 8px; border-left: 3px solid #e74c3c; }
        .stat-label { color: #aaa; font-weight: bold; }
        .stat-value { color: #f39c12; font-weight: bold; }
        .bar { width: 100%; height: 22px; background: rgba(0, 0, 0, 0.6); border-radius: 11px; overflow: hidden; margin-top: 5px; border: 1px solid #555; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #e67e22); transition: width 0.3s; }
        button { flex: 1; min-width: 100px; padding: 12px 20px; background: linear-gradient(135deg, #e74c3c, #c0392b); border: 2px solid #e74c3c; border-radius: 8px; color: #fff; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(231, 76, 60, 0.6); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #333; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 3px solid transparent; color: #aaa; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .tab-btn:hover { color: #f39c12; }
        .tab-btn.active { color: #e74c3c; border-bottom-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .leader-item { background: rgba(50, 50, 100, 0.6); border: 1px solid #555; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .leader-rank { font-weight: bold; color: #f39c12; font-size: 1.2em; min-width: 40px; }
        .leader-info { flex: 1; margin-left: 15px; }
        .leader-name { color: #fff; font-weight: bold; }
        .leader-level { color: #3498db; font-size: 0.9em; }
        .leader-stats { color: #aaa; font-size: 0.85em; }
        .quest-item { background: rgba(50, 50, 100, 0.6); border-left: 3px solid #3498db; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .quest-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .quest-name { color: #fff; font-weight: bold; }
        .quest-reward { color: #27ae60; font-weight: bold; }
        .quest-progress { background: rgba(0, 0, 0, 0.5); height: 15px; border-radius: 8px; overflow: hidden; }
        .quest-progress-bar { height: 100%; background: linear-gradient(90deg, #3498db, #2980b9); transition: width 0.3s; }
        .achievement { background: rgba(50, 50, 100, 0.6); border: 1px solid #555; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .achievement:hover { border-color: #f39c12; transform: translateY(-3px); }
        .achievement-emoji { font-size: 2em; margin-bottom: 5px; }
        .achievement-name { color: #f39c12; font-weight: bold; font-size: 0.9em; }
        .notification { position: fixed; bottom: 30px; right: 20px; background: #27ae60; padding: 16px 24px; border-radius: 10px; animation: slideNotify 0.3s, slideOutNotify 0.3s 2.7s forwards; z-index: 1000; font-weight: bold; }
        @keyframes slideNotify { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutNotify { to { transform: translateX(400px); opacity: 0; } }
        .notification.error { background: #e74c3c; }
        .emoji { font-size: 2.5em; }
        .battle-field { text-align: center; margin: 30px 0; }
        .char-vs { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .character { font-size: 4em; }
        .vs-text { color: #f39c12; font-size: 2em; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 10px; background: rgba(50, 50, 100, 0.6); border: 1px solid #555; color: #fff; border-radius: 5px; margin-bottom: 15px; }
        input[type="text"]::placeholder { color: #999; }
        .log { background: rgba(0, 0, 0, 0.8); border: 1px solid #555; padding: 12px; border-radius: 8px; margin-bottom: 15px; color: #e67e22; font-weight: bold; min-height: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- CLASS SELECTION -->
        <div class="screen active" id="classScreen">
            <div class="card">
                <h1>‚öîÔ∏è RPG</h1>
                <h2>Choose Your Class</h2>
                <input type="text" id="usernameInput" placeholder="Enter your name...">
                <div class="grid" id="classGrid"></div>
            </div>
        </div>

        <!-- MAIN MENU -->
        <div class="screen" id="menuScreen">
            <div class="card">
                <h1>‚öîÔ∏è RPG</h1>
                <div id="profileDiv"></div>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('battle')">Battle</button>
                    <button class="tab-btn" onclick="switchTab('shop')">Shop</button>
                    <button class="tab-btn" onclick="switchTab('quests')">Quests</button>
                    <button class="tab-btn" onclick="switchTab('leaderboard')">Rank</button>
                    <button class="tab-btn" onclick="switchTab('achievements')">Awards</button>
                </div>

                <div class="tab-content active" id="battleTab">
                    <div class="buttons">
                        <button onclick="startBattle()">Hunt</button>
                        <button onclick="reset()">Reset</button>
                    </div>
                </div>

                <div class="tab-content" id="shopTab">
                    <input type="text" id="shopSearch" placeholder="Search items..." onkeyup="filterShop()">
                    <div id="shopGrid"></div>
                </div>

                <div class="tab-content" id="questsTab">
                    <div id="questsDiv"></div>
                </div>

                <div class="tab-content" id="leaderboardTab">
                    <div id="leaderboardDiv"></div>
                </div>

                <div class="tab-content" id="achievementsTab">
                    <div id="achievementsDiv"></div>
                </div>
            </div>
        </div>

        <!-- BATTLE -->
        <div class="screen" id="battleScreen">
            <div class="card">
                <h1>‚öîÔ∏è Battle</h1>
                <div class="char-vs">
                    <div><div class="character" id="playerEmoji">üó°Ô∏è</div><small>You</small></div>
                    <div class="vs-text">VS</div>
                    <div><div class="character" id="enemyEmoji">üëπ</div><small id="enemyName">Enemy</small></div>
                </div>
                <div class="log" id="battleLog">Battle started!</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div><small>Your HP</small><div class="bar"><div class="bar-fill" id="playerHPBar" style="width: 100%;"></div></div></div>
                    <div><small>Enemy HP</small><div class="bar"><div class="bar-fill" id="enemyHPBar" style="width: 100%; background: linear-gradient(90deg, #3498db, #2980b9);"></div></div></div>
                </div>
                <div class="buttons">
                    <button onclick="attack()">Attack</button>
                    <button onclick="skill()">Skill</button>
                    <button onclick="flee()">Flee</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let game = {
            user_id: null,
            username: '',
            player: null,
            enemy: null,
            battle_enemy: null,
            battle_start: 0,
            damage_dealt: 0,
            damage_taken: 0
        };

        let allItems = {};
        let dailyQuests = {};
        let achievements = {};

        async function loadClasses() {
            const res = await fetch(API + '/api/classes');
            const classes = await res.json();
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            for (const [key, cls] of Object.entries(classes)) {
                const div = document.createElement('div');
                div.className = 'btn-class';
                div.innerHTML = `<div class="emoji">${cls.emoji}</div><strong>${cls.name}</strong><br><small>${cls.description}</small>`;
                div.onclick = () => createPlayer(key);
                grid.appendChild(div);
            }
        }

        async function createPlayer(classType) {
            const username = document.getElementById('usernameInput').value.trim() || `Player_${Date.now()}`;
            game.user_id = Date.now();
            game.username = username;

            const res = await fetch(API + '/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, class: classType, username: username })
            });
            if (!res.ok) { notify('Failed!', 'error'); return; }

            const data = await res.json();
            game.player = data.player;
            await loadData();
            showScreen('menuScreen');
            updateProfile();
        }

        async function loadData() {
            const itemsRes = await fetch(API + '/api/items');
            allItems = await itemsRes.json();
            
            const questsRes = await fetch(API + '/api/daily-quests');
            dailyQuests = await questsRes.json();
            
            const achievRes = await fetch(API + '/api/achievements');
            achievements = await achievRes.json();
        }

        function updateProfile() {
            const p = game.player;
            const hpPercent = (p.health / p.max_health) * 100;
            const manaPercent = (p.mana / p.max_mana) * 100;
            const expPercent = (p.exp / (150 * p.level)) * 100;
            
            document.getElementById('profileDiv').innerHTML = `
                <h2>${p.username} - ${p.class_type.toUpperCase()}</h2>
                <div class="stat"><span>Level</span><span>${p.level}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${hpPercent}%;"></div></div>
                <div class="stat"><span>HP</span><span>${p.health}/${p.max_health}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${manaPercent}%; background: #3498db;"></div></div>
                <div class="stat"><span>Mana</span><span>${p.mana}/${p.max_mana}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${expPercent}%; background: #27ae60;"></div></div>
                <div class="stat"><span>EXP</span><span>${p.exp}/${150 * p.level}</span></div>
                <div class="stat"><span>Gold</span><span>üí∞ ${p.gold}</span></div>
            `;
        }

        async function loadShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            
            for (const [category, items] of Object.entries(allItems)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h3>${category}</h3>`;
                grid.appendChild(categoryDiv);
                
                const itemsGrid = document.createElement('div');
                itemsGrid.style.display = 'grid';
                itemsGrid.style.gridTemplateColumns = '1fr 1fr';
                itemsGrid.style.gap = '10px';
                itemsGrid.style.marginBottom = '15px';
                
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.style.background = 'rgba(50, 50, 100, 0.6)';
                    div.style.border = '1px solid #555';
                    div.style.borderRadius = '8px';
                    div.style.padding = '10px';
                    div.style.textAlign = 'center';
                    div.style.cursor = 'pointer';
                    div.style.transition = 'all 0.3s';
                    div.innerHTML = `<div style="font-size: 2em;">${item.emoji}</div><strong>${item.name}</strong><br><small>üí∞ ${item.price}</small>`;
                    div.onclick = () => buyItem(item);
                    div.onmouseover = () => div.style.transform = 'translateY(-5px)';
                    div.onmouseout = () => div.style.transform = 'translateY(0)';
                    itemsGrid.appendChild(div);
                });
                grid.appendChild(itemsGrid);
            }
        }

        async function buyItem(item) {
            if (game.player.level < item.level_req) {
                notify(`Need level ${item.level_req}!`, 'error');
                return;
            }
            if (game.player.gold < item.price) {
                notify('Not enough gold!', 'error');
                return;
            }
            
            const res = await fetch(API + '/api/buy-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, item_id: item.id })
            });
            
            if (res.ok) {
                const data = await res.json();
                game.player.gold = data.gold;
                updateProfile();
                notify(`Bought ${item.name}!`);
            }
        }

        async function loadLeaderboard() {
            const res = await fetch(API + '/api/leaderboard');
            const leaders = await res.json();
            const div = document.getElementById('leaderboardDiv');
            div.innerHTML = '';
            
            leaders.forEach((leader, idx) => {
                const item = document.createElement('div');
                item.className = 'leader-item';
                item.innerHTML = `
                    <div class="leader-rank">#${idx + 1}</div>
                    <div class="leader-info">
                        <div class="leader-name">${leader.username || `Player_${leader.user_id}`}</div>
                        <div class="leader-level">Lvl ${leader.level} ${leader.class_type}</div>
                        <div class="leader-stats">Kills: ${leader.kills} | Battles: ${leader.battles_won}</div>
                    </div>
                    <div style="text-align: right; color: #f39c12;">üí∞ ${leader.gold}</div>
                `;
                div.appendChild(item);
            });
        }

        async function loadQuests() {
            const div = document.getElementById('questsDiv');
            const playerQuests = game.player.daily_quests;
            div.innerHTML = '';
            
            for (const [questId, quest] of Object.entries(dailyQuests)) {
                const playerQuest = playerQuests[questId] || {progress: 0, completed: false};
                const progress = playerQuest.progress || 0;
                const target = quest.target;
                const percent = Math.min(100, (progress / target) * 100);
                
                const questDiv = document.createElement('div');
                questDiv.className = 'quest-item';
                questDiv.innerHTML = `
                    <div class="quest-header">
                        <span class="quest-name">${quest.emoji} ${quest.name}</span>
                        <span class="quest-reward">${playerQuest.completed ? '‚úì Done' : `+${quest.reward} gold`}</span>
                    </div>
                    <div>${progress}/${target}</div>
                    <div class="quest-progress">
                        <div class="quest-progress-bar" style="width: ${percent}%;"></div>
                    </div>
                `;
                div.appendChild(questDiv);
            }
        }

        async function loadAchievements() {
            const div = document.getElementById('achievementsDiv');
            div.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'grid-3';
            
            for (const [achId, ach] of Object.entries(achievements)) {
                const achieved = game.player.achievements[achId] || false;
                const item = document.createElement('div');
                item.className = 'achievement';
                item.style.opacity = achieved ? '1' : '0.5';
                item.innerHTML = `
                    <div class="achievement-emoji">${ach.emoji}</div>
                    <div class="achievement-name">${ach.name}</div>
                    <small>${ach.points} pts</small>
                `;
                item.title = ach.description;
                grid.appendChild(item);
            }
            div.appendChild(grid);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'battle') {
                document.getElementById('battleTab').classList.add('active');
            } else if (tab === 'shop') {
                document.getElementById('shopTab').classList.add('active');
                loadShop();
            } else if (tab === 'quests') {
                document.getElementById('questsTab').classList.add('active');
                loadQuests();
            } else if (tab === 'leaderboard') {
                document.getElementById('leaderboardTab').classList.add('active');
                loadLeaderboard();
            } else if (tab === 'achievements') {
                document.getElementById('achievementsTab').classList.add('active');
                loadAchievements();
            }
        }

        function filterShop() {
            const search = document.getElementById('shopSearch').value.toLowerCase();
            const items = document.querySelectorAll('[style*="background: rgba(50"]');
        }

        async function startBattle() {
            const res = await fetch(API + '/api/enemies');
            const enemies = await res.json();
            const keys = Object.keys(enemies);
            game.battle_enemy = enemies[keys[Math.floor(Math.random() * keys.length)]];
            game.enemy = { health: game.battle_enemy.hp, max_health: game.battle_enemy.hp };
            game.battle_start = Date.now();
            game.damage_dealt = 0;
            game.damage_taken = 0;
            showScreen('battleScreen');
            updateBattle();
        }

        function updateBattle() {
            const hpPercent = Math.max(0, (game.player.health / game.player.max_health) * 100);
            const eHpPercent = Math.max(0, (game.enemy.health / game.enemy.max_health) * 100);
            document.getElementById('playerHPBar').style.width = hpPercent + '%';
            document.getElementById('enemyHPBar').style.width = eHpPercent + '%';
            document.getElementById('enemyEmoji').textContent = game.battle_enemy.emoji;
            document.getElementById('enemyName').textContent = game.battle_enemy.name;
        }

        async function attack() {
            const res = await fetch(API + '/api/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, is_skill: false })
            });
            const data = await res.json();
            const damage = data.damage;
            game.damage_dealt += damage;
            game.enemy.health -= damage;
            
            const isCrit = data.is_crit ? ' üí• CRITICAL!' : '';
            document.getElementById('battleLog').textContent = `You dealt ${damage} damage!${isCrit}`;
            updateBattle();
            
            if (game.enemy.health <= 0) { endBattle(true); } else { setTimeout(enemyAttack, 800); }
        }

        async function skill() {
            document.getElementById('battleLog').textContent = 'Using skill...';
            await new Promise(r => setTimeout(r, 500));
            await attack();
        }

        function enemyAttack() {
            if (game.enemy.health <= 0) return;
            const dmg = Math.max(1, game.battle_enemy.damage - game.player.defense / 2);
            game.damage_taken += dmg;
            game.player.health -= dmg;
            document.getElementById('battleLog').textContent = `${game.battle_enemy.name} deals ${dmg} damage!`;
            updateBattle();
            if (game.player.health <= 0) { endBattle(false); }
        }

        function flee() {
            if (Math.random() > 0.3) {
                document.getElementById('battleLog').textContent = 'Escaped!';
                setTimeout(() => { showScreen('menuScreen'); updateProfile(); }, 1500);
            } else {
                document.getElementById('battleLog').textContent = 'Cannot escape!';
                setTimeout(enemyAttack, 500);
            }
        }

        async function endBattle(won) {
            const duration = Math.floor((Date.now() - game.battle_start) / 1000);
            const res = await fetch(API + '/api/battle-end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: game.user_id,
                    enemy_name: game.battle_enemy.name,
                    won: won,
                    gold: won ? game.battle_enemy.gold : 0,
                    exp: won ? game.battle_enemy.exp : 0,
                    damage_dealt: game.damage_dealt,
                    damage_taken: game.damage_taken,
                    duration: duration
                })
            });
            
            const data = await res.json();
            if (res.ok) {
                game.player = data.player;
                if (won) {
                    notify(`Victory! +${game.battle_enemy.gold} gold!`);
                } else {
                    notify('Defeated...', 'error');
                }
            }
            
            setTimeout(() => { showScreen('menuScreen'); updateProfile(); }, 2000);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function notify(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = 'notification' + (type !== 'success' ? ` ${type}` : '');
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function reset() {
            if (confirm('Reset game?')) {
                game = { user_id: null, player: null, enemy: null, battle_enemy: null };
                showScreen('classScreen');
                loadClasses();
            }
        }

        loadClasses();
        loadData();
    </script>
</body>
</html>