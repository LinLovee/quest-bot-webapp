<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneQuestRPG v4</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a14 0%, #1a1a3f 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .app { width: 100%; max-width: 550px; }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); } 50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.8); } }
        
        .card {
            background: rgba(15, 15, 35, 0.95);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: slideUp 0.5s ease;
        }
        
        h2 {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: #f39c12;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .btn-class {
            background: rgba(50, 50, 100, 0.7);
            border: 2px solid rgba(100, 100, 150, 0.6);
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            color: #fff;
        }
        
        .btn-class:hover {
            border-color: #e74c3c;
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
            background: rgba(50, 50, 120, 0.9);
        }
        
        .emoji { font-size: 2.8em; margin-bottom: 10px; animation: pulse 2s infinite; }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(50, 50, 80, 0.6);
            border-radius: 8px;
            border-left: 3px solid #e74c3c;
        }
        
        .stat-label { color: #aaa; font-weight: bold; }
        .stat-value { color: #f39c12; font-weight: bold; font-size: 1.1em; }
        
        .bar {
            width: 100%;
            height: 22px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 11px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #555;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #e67e22);
            transition: width 0.3s ease;
            border-radius: 11px;
        }
        
        .bar-fill.mana { background: linear-gradient(90deg, #3498db, #2980b9); }
        
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            min-width: 100px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.6);
            background: linear-gradient(135deg, #ff6b5b, #d63223);
        }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:active:not(:disabled) { transform: translateY(-1px); }
        
        .battle-field {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 35px 0;
            min-height: 180px;
            position: relative;
        }
        
        .character {
            font-size: 4em;
            animation: breathe 3s infinite;
            filter: drop-shadow(0 0 10px rgba(231, 76, 60, 0.6));
        }
        
        .character.shake { animation: shake 0.3s ease; }
        
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        
        .log {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #555;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 60px;
            font-size: 0.95em;
            color: #e67e22;
            font-weight: bold;
            line-height: 1.5;
        }
        
        .item {
            background: rgba(50, 50, 100, 0.7);
            border: 2px solid rgba(100, 100, 150, 0.5);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .item:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            background: rgba(60, 70, 130, 0.9);
        }
        
        .item-emoji { font-size: 2.2em; }
        .item-name { font-weight: bold; font-size: 0.9em; color: #f39c12; }
        .item-price { font-size: 0.85em; color: #aaa; }
        .item-stats { font-size: 0.8em; color: #3498db; margin-top: 2px; }
        
        .notification {
            position: fixed;
            bottom: 30px;
            right: 20px;
            background: #27ae60;
            padding: 16px 24px;
            border-radius: 10px;
            animation: slideNotify 0.3s ease, slideOutNotify 0.3s ease 2.7s forwards;
            z-index: 1000;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        
        @keyframes slideNotify { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutNotify { to { transform: translateX(400px); opacity: 0; } }
        
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        .tab-btn:hover { color: #f39c12; }
        .tab-btn.active {
            color: #e74c3c;
            border-bottom-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .level-up-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            padding: 30px;
            border-radius: 15px;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            animation: popupAppear 0.5s ease;
            color: #fff;
        }
        
        @keyframes popupAppear { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        .equipment-slot {
            background: rgba(50, 50, 100, 0.6);
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .equipment-slot:hover { border-color: #f39c12; background: rgba(60, 60, 120, 0.8); }
        .equipment-slot.equipped { border-color: #e74c3c; background: rgba(231, 76, 60, 0.2); }
        
        .search-bar {
            width: 100%;
            padding: 12px;
            background: rgba(50, 50, 100, 0.6);
            border: 2px solid #555;
            border-radius: 8px;
            color: #fff;
            margin-bottom: 15px;
            font-size: 1em;
        }
        
        .search-bar::placeholder { color: #999; }
        .search-bar:focus { outline: none; border-color: #e74c3c; background: rgba(50, 50, 100, 0.9); }
        
        .loading { animation: pulse 1.5s infinite; }
        
        .skill-list {
            background: rgba(50, 50, 100, 0.6);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .skill-item {
            background: rgba(40, 40, 80, 0.8);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.9em;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="card">
            <h1>‚öîÔ∏èRPG</h1>

            <!-- CLASS SELECTION -->
            <div class="screen active" id="classScreen">
                <h2>Choose Your Class</h2>
                <div class="grid" id="classGrid"></div>
            </div>

            <!-- MAIN MENU -->
            <div class="screen" id="menuScreen">
                <div id="profileDiv"></div>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('battle')">‚öîÔ∏è Battle</button>
                    <button class="tab-btn" onclick="switchTab('shop')">üõçÔ∏è Shop</button>
                    <button class="tab-btn" onclick="switchTab('equipment')">üõ°Ô∏è Equipment</button>
                    <button class="tab-btn" onclick="switchTab('stats')">üìä Stats</button>
                </div>
                <div id="battleTab">
                    <div class="buttons">
                        <button onclick="startBattle()">Hunt Enemy</button>
                        <button onclick="showLeaderboard()">Leaderboard</button>
                        <button onclick="reset()">Reset Game</button>
                    </div>
                </div>
                <div id="shopTab" style="display:none;">
                    <input type="text" class="search-bar" id="shopSearch" placeholder="Search items..." onkeyup="filterShop()">
                    <div id="shopGrid"></div>
                </div>
                <div id="equipmentTab" style="display:none;">
                    <div id="equipmentDiv"></div>
                </div>
                <div id="statsTab" style="display:none;">
                    <div id="statsDiv"></div>
                </div>
            </div>

            <!-- BATTLE -->
            <div class="screen" id="battleScreen">
                <h2>‚öîÔ∏è Battle</h2>
                <div class="battle-field">
                    <div>
                        <div class="character" id="playerEmoji">üó°Ô∏è</div>
                        <small>Your Character</small>
                    </div>
                    <div style="color: #f39c12; font-size: 2em; animation: pulse 1.5s infinite;">VS</div>
                    <div>
                        <div class="character" id="enemyEmoji">üëπ</div>
                        <small id="enemyName">Enemy</small>
                    </div>
                </div>
                <div class="log" id="battleLog">Battle started!</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div>
                        <small style="color: #aaa;">YOUR HP</small>
                        <div class="bar"><div class="bar-fill" id="playerHPBar" style="width: 100%;"></div></div>
                        <small id="playerHPText">HP</small>
                    </div>
                    <div>
                        <small style="color: #aaa;">ENEMY HP</small>
                        <div class="bar"><div class="bar-fill" id="enemyHPBar" style="width: 100%; background: linear-gradient(90deg, #3498db, #2980b9);"></div></div>
                        <small id="enemyHPText">HP</small>
                    </div>
                </div>
                <div class="buttons">
                    <button onclick="attack()">‚öîÔ∏è Attack</button>
                    <button id="skillBtn" onclick="skill()">‚ú® Skill</button>
                    <button onclick="usePotion()">üß™ Potion</button>
                    <button onclick="flee()">üèÉ Flee</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let game = {
            user_id: null,
            player: null,
            enemy: null,
            battle_enemy: null,
            battle_start_time: null,
            damage_dealt: 0,
            damage_taken: 0
        };

        let allItems = {};

        async function loadClasses() {
            const res = await fetch(API + '/api/classes');
            const classes = await res.json();
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            for (const [key, cls] of Object.entries(classes)) {
                const div = document.createElement('div');
                div.className = 'btn-class';
                div.innerHTML = `
                    <div class="emoji">${cls.emoji}</div>
                    <strong>${cls.name}</strong><br>
                    <small>${cls.description}</small><br>
                    <small style="color: #aaa; margin-top: 8px;">‚ù§Ô∏è ${cls.health} | ‚öîÔ∏è ${cls.attack}</small>
                `;
                div.onclick = () => createPlayer(key);
                grid.appendChild(div);
            }
        }

        async function createPlayer(classType) {
            game.user_id = Date.now();
            const res = await fetch(API + '/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, class: classType })
            });
            if (!res.ok) { notify('Failed to create character!', 'error'); return; }
            const data = await res.json();
            game.player = data.player;
            showScreen('menuScreen');
            updateProfile();
            loadItems();
        }

        async function loadItems() {
            const res = await fetch(API + '/api/items');
            allItems = await res.json();
        }

        function updateProfile() {
            if (!game.player) return;
            const p = game.player;
            const hpPercent = (p.health / p.max_health) * 100;
            const manaPercent = (p.mana / p.max_mana) * 100;
            const expPercent = (p.exp / (150 * p.level)) * 100;
            
            document.getElementById('profileDiv').innerHTML = `
                <div class="stat"><span class="stat-label">‚≠ê Level</span><span class="stat-value">${p.level}</span></div>
                <div class="stat"><span class="stat-label">‚ù§Ô∏è Health</span><span class="stat-value">${p.health}/${p.max_health}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${hpPercent}%;"></div></div>
                <div class="stat"><span class="stat-label">üíé Mana</span><span class="stat-value">${p.mana}/${p.max_mana}</span></div>
                <div class="bar"><div class="bar-fill mana" style="width: ${manaPercent}%;"></div></div>
                <div class="stat"><span class="stat-label">üìà EXP</span><span class="stat-value">${p.exp}/${150 * p.level}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${expPercent}%; background: linear-gradient(90deg, #27ae60, #16a085);"></div></div>
                <div class="stat"><span class="stat-label">üí∞ Gold</span><span class="stat-value">${p.gold}</span></div>
            `;
        }

        async function loadShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            
            for (const [category, items] of Object.entries(allItems)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h3 style="color: #f39c12; margin: 15px 0 10px 0;">${category.toUpperCase()}</h3>`;
                grid.appendChild(categoryDiv);
                
                const itemsGrid = document.createElement('div');
                itemsGrid.style.display = 'grid';
                itemsGrid.style.gridTemplateColumns = '1fr 1fr';
                itemsGrid.style.gap = '10px';
                itemsGrid.style.marginBottom = '15px';
                
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    let stats = '';
                    if (item.attack) stats += `‚öîÔ∏è +${item.attack} `;
                    if (item.defense) stats += `üõ°Ô∏è +${item.defense} `;
                    if (item.crit) stats += `üí• +${item.crit}% `;
                    if (item.heal) stats += `‚ù§Ô∏è ${item.heal} `;
                    
                    div.innerHTML = `
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-stats">${stats}</div>
                        <div class="item-price">üí∞ ${item.price}</div>
                    `;
                    div.onclick = () => buyItem(item);
                    itemsGrid.appendChild(div);
                });
                grid.appendChild(itemsGrid);
            }
        }

        function filterShop() {
            const search = document.getElementById('shopSearch').value.toLowerCase();
            const items = document.querySelectorAll('.item');
            items.forEach(item => {
                const name = item.querySelector('.item-name').textContent.toLowerCase();
                item.style.display = name.includes(search) ? 'flex' : 'none';
            });
        }

        async function buyItem(item) {
            if (game.player.level < item.level_req) {
                notify(`Need level ${item.level_req}!`, 'warning');
                return;
            }
            if (game.player.gold < item.price) {
                notify('Not enough gold!', 'error');
                return;
            }
            
            const res = await fetch(API + '/api/buy-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, item_id: item.id })
            });
            
            if (res.ok) {
                const data = await res.json();
                game.player.gold = data.gold;
                game.player.inventory[item.id] = (game.player.inventory[item.id] || 0) + 1;
                updateProfile();
                notify(`‚úÖ Bought ${item.name}!`);
            } else {
                notify('Purchase failed!', 'error');
            }
        }

        function switchTab(tab) {
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('battleTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('equipmentTab').style.display = 'none';
            document.getElementById('statsTab').style.display = 'none';
            
            if (tab === 'shop') {
                document.getElementById('shopTab').style.display = 'block';
                loadShop();
            } else if (tab === 'battle') {
                document.getElementById('battleTab').style.display = 'block';
            } else if (tab === 'equipment') {
                document.getElementById('equipmentTab').style.display = 'block';
                updateEquipment();
            } else if (tab === 'stats') {
                document.getElementById('statsTab').style.display = 'block';
                updateStats();
            }
        }

        function updateEquipment() {
            const div = document.getElementById('equipmentDiv');
            div.innerHTML = `
                <div class="equipment-slot">
                    <strong>‚öîÔ∏è WEAPON</strong>
                    <small id="weaponEquipped">No weapon equipped</small>
                </div>
                <div class="equipment-slot">
                    <strong>üõ°Ô∏è ARMOR</strong>
                    <small id="armorEquipped">No armor equipped</small>
                </div>
                <div class="equipment-slot">
                    <strong>üíç ACCESSORY</strong>
                    <small id="accessoryEquipped">No accessory equipped</small>
                </div>
                <h3 style="color: #f39c12; margin-top: 20px;">Your Inventory</h3>
                <div id="inventoryDiv"></div>
            `;
            
            // Display equipped items
            if (game.player.equipment.weapon) {
                document.getElementById('weaponEquipped').textContent = 'Equipped';
            }
            if (game.player.equipment.armor) {
                document.getElementById('armorEquipped').textContent = 'Equipped';
            }
            if (game.player.equipment.accessory) {
                document.getElementById('accessoryEquipped').textContent = 'Equipped';
            }
            
            // Display inventory items
            const inv = document.getElementById('inventoryDiv');
            inv.innerHTML = '';
            for (const [itemId, count] of Object.entries(game.player.inventory)) {
                if (count > 0) {
                    let item = null;
                    for (const category of Object.values(allItems)) {
                        const found = category.find(i => i.id === itemId);
                        if (found) { item = found; break; }
                    }
                    if (item) {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerHTML = `
                            <div class="item-emoji">${item.emoji}</div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-stats">x${count}</div>
                        `;
                        div.onclick = () => equipItem(item.id);
                        inv.appendChild(div);
                    }
                }
            }
        }

        async function equipItem(itemId) {
            const res = await fetch(API + '/api/equip-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, item_id: itemId })
            });
            
            if (res.ok) {
                const data = await res.json();
                notify(data.message);
                updateEquipment();
            }
        }

        function updateStats() {
            const p = game.player;
            const div = document.getElementById('statsDiv');
            div.innerHTML = `
                <div class="stat"><span class="stat-label">‚öîÔ∏è Attack</span><span class="stat-value">${p.attack}</span></div>
                <div class="stat"><span class="stat-label">üõ°Ô∏è Defense</span><span class="stat-value">${p.defense}</span></div>
                <div class="stat"><span class="stat-label">üí• Crit Chance</span><span class="stat-value">${p.crit_chance.toFixed(1)}%</span></div>
                <div class="stat"><span class="stat-label">üéØ Dodge Chance</span><span class="stat-value">${p.dodge_chance.toFixed(1)}%</span></div>
                <div class="stat"><span class="stat-label">üí¢ Crit Damage</span><span class="stat-value">${(p.crit_damage * 100).toFixed(0)}%</span></div>
                <div class="stat"><span class="stat-label">‚öîÔ∏è Battles Won</span><span class="stat-value">${p.battles_won}</span></div>
                <div class="stat"><span class="stat-label">üíÄ Total Kills</span><span class="stat-value">${p.kills}</span></div>
                <div class="stat"><span class="stat-label">üí¢ Damage Dealt</span><span class="stat-value">${p.damage_dealt}</span></div>
            `;
        }

        async function startBattle() {
            const res = await fetch(API + '/api/enemies');
            const enemies = await res.json();
            const keys = Object.keys(enemies);
            const randomIndex = Math.floor(Math.random() * keys.length);
            game.battle_enemy = enemies[keys[randomIndex]];
            game.enemy = { health: game.battle_enemy.hp, max_health: game.battle_enemy.hp };
            game.battle_start_time = Date.now();
            game.damage_dealt = 0;
            game.damage_taken = 0;
            showScreen('battleScreen');
            updateBattle();
        }

        function updateBattle() {
            const hpPercent = Math.max(0, (game.player.health / game.player.max_health) * 100);
            const eHpPercent = Math.max(0, (game.enemy.health / game.enemy.max_health) * 100);
            document.getElementById('playerHPBar').style.width = hpPercent + '%';
            document.getElementById('enemyHPBar').style.width = eHpPercent + '%';
            document.getElementById('playerHPText').textContent = `${game.player.health}/${game.player.max_health}`;
            document.getElementById('enemyHPText').textContent = `${game.enemy.health}/${game.enemy.max_health}`;
            document.getElementById('enemyEmoji').textContent = game.battle_enemy.emoji;
            document.getElementById('enemyName').textContent = game.battle_enemy.name;
        }

        async function attack() {
            const res = await fetch(API + '/api/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, is_skill: false })
            });
            const data = await res.json();
            const damage = data.damage;
            game.damage_dealt += damage;
            game.enemy.health -= damage;
            game.player.mana = data.mana;
            
            const isCrit = data.is_crit ? 'üí• CRITICAL!' : '';
            document.getElementById('battleLog').textContent = `You dealt ${damage} damage! ${isCrit}`;
            document.getElementById('playerEmoji').classList.add('shake');
            setTimeout(() => document.getElementById('playerEmoji').classList.remove('shake'), 300);
            
            updateBattle();
            if (game.enemy.health <= 0) { endBattle(true); } else { setTimeout(enemyAttack, 1000); }
        }

        async function skill() {
            const res = await fetch(API + '/api/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, is_skill: true, skill_name: 'power_strike' })
            });
            if (!res.ok) { const data = await res.json(); notify(data.error, 'error'); return; }
            const data = await res.json();
            const damage = data.damage;
            game.damage_dealt += damage;
            game.enemy.health -= damage;
            game.player.mana = data.mana;
            document.getElementById('battleLog').textContent = `‚ú® SKILL ACTIVATED! ${damage} damage!`;
            document.getElementById('playerEmoji').classList.add('shake');
            setTimeout(() => document.getElementById('playerEmoji').classList.remove('shake'), 300);
            
            updateBattle();
            if (game.enemy.health <= 0) { endBattle(true); } else { setTimeout(enemyAttack, 1000); }
        }

        function enemyAttack() {
            if (game.enemy.health <= 0) return;
            const dmg = Math.max(1, game.battle_enemy.damage - game.player.defense / 2);
            game.damage_taken += dmg;
            game.player.health -= dmg;
            document.getElementById('battleLog').textContent = `${game.battle_enemy.name} attacks! ${dmg} damage!`;
            document.getElementById('enemyEmoji').classList.add('shake');
            setTimeout(() => document.getElementById('enemyEmoji').classList.remove('shake'), 300);
            
            updateBattle();
            if (game.player.health <= 0) { endBattle(false); }
        }

        function usePotion() {
            if (game.player.health >= game.player.max_health) {
                notify('Already at full health!', 'warning');
                return;
            }
            const heal = 50;
            game.player.health = Math.min(game.player.max_health, game.player.health + heal);
            document.getElementById('battleLog').textContent = `Used potion! Healed ${heal} HP`;
            updateBattle();
            setTimeout(enemyAttack, 1000);
        }

        function flee() {
            if (Math.random() > 0.3) {
                document.getElementById('battleLog').textContent = 'üèÉ Escaped successfully!';
                setTimeout(() => { showScreen('menuScreen'); updateProfile(); }, 1500);
            } else {
                document.getElementById('battleLog').textContent = '‚ùå Could not escape!';
                setTimeout(enemyAttack, 500);
            }
        }

        async function endBattle(won) {
            const duration = Math.floor((Date.now() - game.battle_start_time) / 1000);
            const res = await fetch(API + '/api/battle-end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: game.user_id,
                    enemy_name: game.battle_enemy.name,
                    won: won,
                    gold: won ? game.battle_enemy.gold : 0,
                    exp: won ? game.battle_enemy.exp : 0,
                    damage_dealt: game.damage_dealt,
                    damage_taken: game.damage_taken,
                    duration: duration
                })
            });
            const data = await res.json();
            
            const playerRes = await fetch(API + `/api/player?user_id=${game.user_id}`);
            game.player = await playerRes.json();
            
            if (won) {
                notify(`üéâ Victory! +${game.battle_enemy.gold} gold!`);
                if (data.level_up) {
                    showLevelUpPopup(data.level_info);
                }
            } else {
                notify('üíÄ Defeated...', 'error');
            }
            
            setTimeout(() => { showScreen('menuScreen'); updateProfile(); }, 2500);
        }

        function showLevelUpPopup(info) {
            const popup = document.createElement('div');
            popup.className = 'level-up-popup';
            popup.innerHTML = `
                <h2>‚≠ê LEVEL UP!</h2>
                <p style="font-size: 1.5em; margin: 10px 0;">Level ${info.new_level}</p>
                <p>+${info.health_increase} HP</p>
                <p>+${info.attack_increase} ATK</p>
            `;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 3000);
        }

        async function showLeaderboard() {
            const res = await fetch(API + '/api/leaderboard');
            const leaders = await res.json();
            let html = '<h2>üèÜ Leaderboard</h2>';
            leaders.forEach((leader, index) => {
                html += `<div class="stat"><span>${index + 1}. Player ${leader.user_id}</span><span>Lvl ${leader.level}</span></div>`;
            });
            notify('Check top players');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function notify(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = 'notification' + (type !== 'success' ? ` ${type}` : '');
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function reset() {
            if (confirm('Reset your character?')) {
                game = { user_id: null, player: null, enemy: null, battle_enemy: null };
                showScreen('classScreen');
                loadClasses();
            }
        }

        loadClasses();
    </script>
</body>
</html>