<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneQuestRPG v3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a14 0%, #1a1a3f 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .app { width: 100%; max-width: 500px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fade 0.3s ease; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        .card {
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
        }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 20px; color: #f39c12; }
        h2 { font-size: 1.5em; margin-bottom: 20px; color: #e74c3c; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .btn-class {
            background: rgba(50, 50, 100, 0.8);
            border: 2px solid rgba(100, 100, 150, 0.5);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            color: #fff;
        }
        .btn-class:hover { border-color: #e74c3c; transform: translateY(-5px); }
        .emoji { font-size: 2.5em; margin-bottom: 10px; }
        .stat { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px; background: rgba(50, 50, 80, 0.5); border-radius: 5px; }
        .stat-label { color: #aaa; }
        .stat-value { color: #f39c12; font-weight: bold; }
        .bar { width: 100%; height: 20px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; overflow: hidden; margin-top: 5px; border: 1px solid #555; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #e67e22); transition: width 0.3s ease; }
        .buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        button {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.5); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .battle-field { display: flex; justify-content: space-around; align-items: center; margin: 40px 0; min-height: 150px; }
        .character { font-size: 3.5em; animation: breathe 3s infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .log { background: rgba(0, 0, 0, 0.7); border: 1px solid #555; padding: 15px; border-radius: 8px; margin-bottom: 20px; min-height: 50px; font-size: 0.9em; color: #e67e22; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .item { background: rgba(50, 50, 100, 0.8); border: 1px solid #555; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .item:hover { border-color: #3498db; transform: translateY(-3px); }
        .notification {
            position: fixed;
            bottom: 30px;
            right: 20px;
            background: #27ae60;
            padding: 15px 20px;
            border-radius: 8px;
            animation: slide 0.3s ease, slide-out 0.3s ease 2.7s forwards;
            z-index: 1000;
        }
        @keyframes slide { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out { to { transform: translateX(400px); opacity: 0; } }
        .error { background: #e74c3c; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; background: rgba(100, 100, 150, 0.3); border: 1px solid #555; color: #aaa; cursor: pointer; border-radius: 5px; transition: all 0.2s ease; }
        .tab-btn.active { background: #e74c3c; color: #fff; border-color: #e74c3c; }
    </style>
</head>
<body>
    <div class="app">
        <div class="card">
            <h1>‚öîÔ∏èRPG</h1>

            <!-- CLASS SELECTION -->
            <div class="screen active" id="classScreen">
                <h2>Select Class</h2>
                <div class="grid" id="classGrid"></div>
            </div>

            <!-- MAIN MENU -->
            <div class="screen" id="menuScreen">
                <div id="profileDiv"></div>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('battle')">Battle</button>
                    <button class="tab-btn" onclick="switchTab('shop')">Shop</button>
                </div>
                <div id="battleTab">
                    <div class="buttons">
                        <button onclick="startBattle()">Hunt</button>
                        <button onclick="reset()">Reset</button>
                    </div>
                </div>
                <div id="shopTab" style="display:none;">
                    <div class="grid-2" id="shopGrid"></div>
                </div>
            </div>

            <!-- BATTLE -->
            <div class="screen" id="battleScreen">
                <h2>Battle</h2>
                <div class="battle-field">
                    <div>
                        <div class="character" id="playerEmoji">üó°Ô∏è</div>
                        <small>Player</small>
                    </div>
                    <div style="color: #999; font-size: 2em;">‚ö°</div>
                    <div>
                        <div class="character" id="enemyEmoji">üëπ</div>
                        <small id="enemyName">Enemy</small>
                    </div>
                </div>
                <div class="log" id="battleLog">Battle started...</div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <small>HP</small>
                        <div class="bar"><div class="bar-fill" id="playerHPBar" style="width: 100%;"></div></div>
                    </div>
                    <div style="flex: 1;">
                        <small>Enemy HP</small>
                        <div class="bar"><div class="bar-fill" id="enemyHPBar" style="width: 100%; background: linear-gradient(90deg, #3498db, #2980b9);"></div></div>
                    </div>
                </div>
                <div class="buttons">
                    <button onclick="attack()">Attack</button>
                    <button id="skillBtn" onclick="skill()">Skill</button>
                    <button onclick="flee()">Flee</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let game = {
            user_id: null,
            player: null,
            enemy: null,
            battle_enemy: null
        };

        async function loadClasses() {
            const res = await fetch(API + '/api/classes');
            const classes = await res.json();
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            for (const [key, cls] of Object.entries(classes)) {
                const div = document.createElement('div');
                div.className = 'btn-class';
                div.innerHTML = `<div class="emoji">${cls.emoji}</div><strong>${cls.name}</strong><br><small>${cls.description}</small>`;
                div.onclick = () => createPlayer(key);
                grid.appendChild(div);
            }
        }

        async function createPlayer(classType) {
            game.user_id = Date.now();
            const res = await fetch(API + '/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, class: classType })
            });
            if (!res.ok) { notify('Error!', true); return; }
            const data = await res.json();
            game.player = data.player;
            showScreen('menuScreen');
            updateProfile();
        }

        function updateProfile() {
            const p = game.player;
            const hpPercent = (p.health / p.max_health) * 100;
            const manaPercent = (p.mana / p.max_mana) * 100;
            document.getElementById('profileDiv').innerHTML = `
                <div class="stat"><span class="stat-label">Level</span><span class="stat-value">${p.level}</span></div>
                <div class="stat"><span class="stat-label">HP</span><span class="stat-value">${p.health}/${p.max_health}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${hpPercent}%;"></div></div>
                <div class="stat"><span class="stat-label">Mana</span><span class="stat-value">${p.mana}/${p.max_mana}</span></div>
                <div class="bar"><div class="bar-fill" style="width: ${manaPercent}%; background: linear-gradient(90deg, #3498db, #2980b9);"></div></div>
                <div class="stat"><span class="stat-label">Attack</span><span class="stat-value">${p.attack}</span></div>
                <div class="stat"><span class="stat-label">Defense</span><span class="stat-value">${p.defense}</span></div>
                <div class="stat"><span class="stat-label">Gold</span><span class="stat-value">${p.gold}</span></div>
            `;
        }

        async function loadShop() {
            const res = await fetch(API + `/api/items?user_id=${game.user_id}`);
            const data = await res.json();
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<div style="font-size: 2em;">${item.emoji}</div><strong>${item.name}</strong><br>üí∞ ${item.price}`;
                div.onclick = () => buyItem(item.name, item.price);
                grid.appendChild(div);
            });
        }

        function switchTab(tab) {
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'shop') {
                document.getElementById('shopTab').style.display = 'block';
                document.getElementById('battleTab').style.display = 'none';
                loadShop();
            } else {
                document.getElementById('shopTab').style.display = 'none';
                document.getElementById('battleTab').style.display = 'block';
            }
        }

        function buyItem(name, price) {
            if (game.player.gold < price) { notify('Not enough gold!', true); return; }
            game.player.gold -= price;
            updateProfile();
            notify(`Bought ${name}!`);
        }

        async function startBattle() {
            const res = await fetch(API + '/api/enemies');
            const enemies = await res.json();
            const keys = Object.keys(enemies);
            game.battle_enemy = enemies[keys[Math.floor(Math.random() * keys.length)]];
            game.enemy = { health: game.battle_enemy.hp, max_health: game.battle_enemy.hp };
            showScreen('battleScreen');
            updateBattle();
        }

        function updateBattle() {
            const hpPercent = Math.max(0, (game.player.health / game.player.max_health) * 100);
            const eHpPercent = Math.max(0, (game.enemy.health / game.enemy.max_health) * 100);
            document.getElementById('playerHPBar').style.width = hpPercent + '%';
            document.getElementById('enemyHPBar').style.width = eHpPercent + '%';
            document.getElementById('enemyEmoji').textContent = game.battle_enemy.emoji;
            document.getElementById('enemyName').textContent = game.battle_enemy.name;
            updateSkillBtn();
        }

        async function attack() {
            const res = await fetch(API + '/api/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, is_skill: false })
            });
            const data = await res.json();
            game.enemy.health -= data.damage;
            game.player.mana = data.mana;
            document.getElementById('battleLog').textContent = `Dealt ${data.damage} damage!`;
            updateBattle();
            if (game.enemy.health <= 0) { endBattle(true); } else { setTimeout(enemyAttack, 1000); }
        }

        async function skill() {
            const res = await fetch(API + '/api/attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: game.user_id, is_skill: true })
            });
            if (!res.ok) { const data = await res.json(); notify(data.error, true); return; }
            const data = await res.json();
            game.enemy.health -= data.damage;
            game.player.mana = data.mana;
            document.getElementById('battleLog').textContent = `Skill! ${data.damage} damage!`;
            updateBattle();
            if (game.enemy.health <= 0) { endBattle(true); } else { setTimeout(enemyAttack, 1000); }
        }

        function enemyAttack() {
            if (game.enemy.health <= 0) return;
            const dmg = Math.max(1, game.battle_enemy.damage - game.player.defense / 2);
            game.player.health -= dmg;
            document.getElementById('battleLog').textContent = `${game.battle_enemy.name} deals ${dmg} damage!`;
            updateBattle();
            if (game.player.health <= 0) { endBattle(false); }
        }

        function flee() {
            if (Math.random() > 0.3) {
                notify('Escaped!');
                showScreen('menuScreen');
            } else {
                document.getElementById('battleLog').textContent = 'Cannot escape!';
                setTimeout(enemyAttack, 500);
            }
        }

        async function endBattle(won) {
            const res = await fetch(API + '/api/battle-end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: game.user_id,
                    won: won,
                    gold: won ? game.battle_enemy.gold : 0,
                    exp: won ? game.battle_enemy.exp : 0
                })
            });
            const playerRes = await fetch(API + `/api/player?user_id=${game.user_id}`);
            game.player = await playerRes.json();
            if (won) { notify(`Won! +${game.battle_enemy.gold} gold!`); }
            setTimeout(() => { showScreen('menuScreen'); updateProfile(); }, 2000);
        }

        function updateSkillBtn() {
            const btn = document.getElementById('skillBtn');
            const cooldown = 30; // placeholder
            btn.disabled = false;
            btn.textContent = 'Skill';
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function notify(msg, isError = false) {
            const div = document.createElement('div');
            div.className = 'notification' + (isError ? ' error' : '');
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function reset() { location.reload(); }

        loadClasses();
    </script>
</body>
</html>